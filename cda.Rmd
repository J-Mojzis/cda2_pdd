---
title: "CDA2 Challenge"
output: html_notebook
---


```{r Libraries installieren, include=FALSE}

library(tidyverse) #Data-wrangling, Visualisierungen
library(networkD3) #Sankey
library(plotly) #Interaktive Visualisierungen
library(esquisse) # tool um Visualisierungen zu prüfen
library(highcharter) #Sankey
library(openxlsx) #xlsx Dateien öffnen
```


```{r Datensätze einlesen, include = FALSE}
df_original <- read.csv("https://swissvotes.ch/page/dataset/swissvotes_dataset.csv", header=TRUE, sep=";", na = c("NA", "."))
as_nation <- read.xlsx("https://www.sem.admin.ch/dam/sem/de/data/publiservice/statistik/asylstatistik/uebersichten/gesuche-nation-ab-1986-d.xlsx.download.xlsx/gesuche-nation-ab-1986-d.xlsx")


```



```{r Datensatz anschauen, include=FALSE}
head(df_original)
str(df_original)

```



```{r Bereinigung des Datensatzes}
#Variablen definieren um nachher mehrere Spalten gleichzeitig zu mutieren

positionen  <- df_original %>%
  select(ends_with(".pos")|starts_with("p.")|starts_with("pdev")) 

hauptthema <- df_original %>%
  select(d1e1, d2e1 ,d3e1)

unterthema <- df_original %>%
  select(d1e2, d2e2 ,d3e2)

unterunterthema <- df_original %>%
  select(d1e3, d2e3 ,d3e3)

daten <- df_original%>%
  select(datum, starts_with("dat."))

resultate <- df_original %>%
  select(ends_with("annahme")| volk | stand)

parteien <- c(".svp", ".fdp", ".sp", ".cvp", ".gsp", ".sps")

#Data-Wrangling (Variablen codieren)
data <- df_original %>%
  select(-(ends_with(".fr")|ends_with("_f")|ends_with(".en")))%>% #Entfernung französische Übersetzungen
  rename(Kurztitel = titel_kurz_d, Titel = titel_off_d, ) %>% 

    mutate(rechtsform = factor(case_when(
    rechtsform == 1 ~ "Obligatorisches Referendum",
    rechtsform == 2 ~ "Fakultatives Referendum",
    rechtsform == 3 ~ "Volksinitiative",
    rechtsform == 4 ~ "Gegenentwurf zu Volksinitiative",
    rechtsform == 5 ~ "Stichfrage")))%>% 
  
    mutate(dep = factor(case_when(
    dep == 1 ~ "EDA",
    dep == 2 ~ "EDI",
    dep == 3 ~ "EJPD",
    dep == 4 ~ "VBS",
    dep == 5 ~ "EFD",
    dep == 6 ~ "WBF",
    dep == 7 ~ "UVEK",
    dep == 8 ~ "BK")))%>%
  mutate (Jahr = as.integer(format(as.Date(datum, format='%d.%m.%Y'), format="%Y"))) %>% 
  
  mutate(across(names(positionen), 
           ~ factor(case_when(. == 1 ~ "Befürwortend",
    .== 2 ~"Ablehnend",
    .== 3 ~"Keine",
    .== 4 ~"Leere Abgabe",
    .== 5 ~"Stimmfreigabe",
    .== 8 ~"Vorzug für den Gegenentwurf",
    .== 9 ~"Vorzug für Volksinitiative",
    . == 66 ~"keine",
    . == 9999 ~"Partei ex. nicht",)))) %>%
  
  mutate(across(names(hauptthema), 
             ~ factor(case_when(. == 1 ~ "Staatsordnung",
    .== 2 ~ "Aussenpolitik",
    .== 3 ~"Sicherheitspolitik",
    .== 4 ~"Wirtschaft",
    .== 5 ~"Landwirtschaft",
    .== 6 ~"Öffentliche Finanzen",
    .== 7 ~"Energie",
    .== 8 ~"Verkehr und Infrastruktur",
    .== 9 ~"Umwelt und Lebensraum",
    .== 10 ~"Sozialpolitik",
    .== 11 ~"Bildung und Forschung",
    .== 12 ~"Kultur, Religion, Medien",))))%>%
  
  mutate(across(names(unterthema), 
             ~ factor(case_when(. == 2.1 ~ "Aussenpolitische Grundhaltung",
    .== 2.2 ~ "Europapolitik",
    .== 2.3 ~ "Internationale Organisationen",
    .== 2.4 ~ "Entwicklungszusammenarbeit",
    .== 2.5 ~ "Staatsverträge mit einzelnen Staaten",
    .== 2.6 ~"Aussenwirtschaftspolitik",
    .== 2.7 ~"Diplomatie",
    .== 2.8 ~"Auslandschweizer:innen",
    .== 3.1 ~"Öffentliche Sicherheit",
    .== 3.2 ~"Armee",
    .== 3.3 ~"Landesversorgung",
    .== 10.3 ~"Ausländer & Flüchtlinge", 
    TRUE ~"andere")))) %>%
  mutate(across(names(unterunterthema), 
             ~ factor(case_when(. == 10.31 ~ "Ausländerpolitik",
    .== 10.32 ~ "Flüchtlinge",
     TRUE ~"andere")))) %>%
  
  mutate(across(names(daten), 
                ~ as.Date(., "%d.%m.%Y"))) %>%
  
  mutate(across(names(resultate), 
                ~ factor(case_when(. == 0 ~"abgelehnt", 
                .== 1 ~ "angenommen", 
                .== 3 ~ "Ständemehr nicht nötig", 
                .== 8 ~ "Gegenentwurf angenommen", 
                .== 9 ~ "Volksinitiative angenommen" )))) %>% 
  mutate(anr = as.factor(anr)) 
  

  
```


```{r Eingeschraenkten Datensatz erstellen: neue Variablen erzeugen, Thema filtern nach Ausländer & Flüchtlinge} 
data$bet_volkja.proz <- (data$bet*(data$volkja.proz/100))

df <- data %>%
  select(anr,Jahr, Kurztitel, rechtsform, annahme, bet_volkja.proz, bet,  d1e1:br.pos, bv.pos:nr.pos, sr.pos, unter_g, unter_u, ends_with(parteien), ja.lager, nein.lager, volk:stand, volkja.proz, ktjaproz,matches("...bet"),matches("...japroz"), matches("...annahme"),swissvoteslink, anneepolitique, info_br.de, info_dep.de, info_amt.de)


#neue Variablen: prüfen, ob Thema vorkommt und wenn ja, trägt es 1 ein (sonst 0)
df$Sicherheitspolitik <- +(rowSums(df[2:12] == 'Sicherheitspolitik', na.rm = TRUE) > 0)
df$Aussenpolitik <- +(rowSums(df[2:12] == 'Aussenpolitik', na.rm = TRUE) > 0)
df$Ausländer <- +(rowSums(df[2:12] == 'Ausländerpolitik', na.rm = TRUE) > 0)
df$Flüchtlinge <- +(rowSums(df[2:12] == 'Flüchtlinge', na.rm = TRUE) > 0)

#neue Spalte: fasst Themen der neuen Spalten zusammen, alles andere wird als "anderes" kategorisiert. 
df <- df %>% 
    mutate(Thema = factor(case_when(
    Sicherheitspolitik == 1 ~ "Sicherheitspolitik",
    Aussenpolitik == 1 ~ "Aussenpolitik",
    Flüchtlinge == 1 ~ "Flüchtlinge",
    Ausländer == 1 ~ "Ausländer",
    TRUE ~"andere"))) %>% 
    mutate(Jahrzehnt = as.factor(floor(Jahr/10)*10)) %>% 
    mutate(relevant = ifelse(Thema == "andere", "nein", "ja")) 


#Reduzierter Datensatz mit Ausländer & Flüchtlingsthemen
ausländer <- df %>% 
  filter(Thema %in% c("Ausländer", "Flüchtlinge")) %>%
  filter(rechtsform != "Stichfrage")

#Korrekturvektor: dreht Ergebnis von Prozent Ja-Stimmen bei pro-Ausländer Vorlagen um (aus 23% ja wird 77% ja)
korrektur = c(0,0,0,0,0,0,0,100,100,0,0,0,100,0,0,0,0,0,0,0,0,0,0,0,100)

#Datensatz nur mit Spalten mit Ja-Prozenten, ohne Jura
kantone_japroz <- ausländer %>% 
  select(ends_with(".japroz"),volkja.proz) %>% 
  select(-ju.japroz)
cor(kantone_japroz$zh.japroz,ausländer$zh.japroz)

#Korrekturvektor auf allen Spalten anwenden
for (i in 1:length(kantone_japroz)) {
  kantone_japroz[,i] <- abs(kantone_japroz[,i] -korrektur)}

#prüfen, ob Korrektur erfolgreich war: Wenn Korrelation nicht = 1, wurde Korrektur durchgeführt
cor(kantone_japroz$zh.japroz,ausländer$zh.japroz) 
cor(kantone_japroz$ge.japroz,ausländer$ge.japroz)

#Neuen Datensatz komplett mit den korrigierten Werten
df_ausländer_korr <- select(ausländer, -c(names(kantone_japroz))) %>% bind_cols(kantone_japroz)


```


```{r Summary statistics anschauen, include = FALSE} 
#Datensätze überprüfen
summary(ausländer)
summary(kantone_japroz)


```


```{r statistische Kennzahlen} 
#Durchschnitt allg. Schweiz bei Abstimmungen vs. Abstimmungen über Ausländer
mean(df$bet, na.rm = TRUE)
mean(ausländer$bet)

kantone_bet <- ausländer %>%
  select(ends_with(".bet")) %>% 
  summarize(mean = colMeans(., na.rm = TRUE))

Liste_kantone <- list(names(colMeans(ausländer[39:64])))
```


```{r diverses herumspielen} 


# 
# svp_ja <- ausländer %>% 
#   filter(p.svp == "Befürwortend") %>% 
#   summarize(Durchschnitt = colMeans(ausländer[39:64], na.rm = TRUE))
# 
# 
# 
# svp_nein <- ausländer %>% 
#   filter(p.svp == "Ablehnend") %>% 
#   summarise_at(c(names(kantone_japroz)), mean, na.rm = TRUE)


svp_total <- ausländer %>% 
  group_by(p.svp) %>% 
  summarise_at(c(names(kantone_japroz)), mean, na.rm = TRUE)


ggplot(svp_total, aes(p.svp, zh.japroz))+
  geom_jitter()

# SVP_kt <- cbind(argh = Liste_kantone, svp_ja, svp_nein) 

colnames(SVP_kt)[1] <- "Kanton"


mean(df$volkja.proz, na.rm = TRUE)

annahmen_ausländer <- ausländer %>% 
  group_by(rechtsform) %>% 
  summarize(mean = mean(volkja.proz, na.rm = TRUE))
mean(ausländer$volkja.proz)


parteien_japroz <- ausländer %>% 
  group_by(p.svp, p.fdp, p.sps, p.cvp) %>% 
  summarize(jastimmen = mean(volkja.proz))





#colMeans(ausländer["zh.bet":"ge.bet"], na.rm = TRUE)
ggplot(ausländer, aes(Jahrzehnt, fill = Thema)) + 
  geom_bar()


```

```{r Visualisierungen ggf. brauchbar} 

#Stimmbeteiligung Kantone im Vergleich für Abstimmungen
ggplot(df_ausländer_korr, aes(bet, Kurztitel,fill= annahme))+
  geom_col()

ggplot(df, aes(relevant, volkja.proz))+
  geom_boxplot()

ggplot(df, aes(Thema, bet, fill = annahme))+
  geom_boxplot()


stimmbet <- ggplot(df, aes(relevant, bet, fill = relevant))+
  geom_boxplot() +
  scale_fill_brewer(palette="Set1", direction=-1)+
  labs(title = "Stimmbeteiligung für Abstimmungsvorlagen",
       subtitle = "Thema Ausländer/Flüchtlingspolitik vs. restliche Abstimmungen",
       x = "Ausländer/Flüchtlingspolitik",
       y = "Stimmbeteiligung in Prozent") 
  

ggplotly(stimmbet)


#Stimmbeteiligung Kantone im Vergleich für Abstimmungen
ggplot(df_ausländer_korr, aes(bet, anr,fill= annahme))+
  geom_col()+
  labs(title = "Durchschnittliche Stimmbeteiligung für Vorlagen mit Thema Ausländer",
       y = "Vorlage-Nr",
       x = "Beteiligung in %")

df_ausländer_korr %>%   
  mutate(Jahrzehnt = as.factor(floor(Jahr/10)*10)) %>%
  group_by(Jahrzehnt, annahme, bet) %>% 
  count(Jahrzehnt, annahme) %>% 
  ungroup() %>% 
  ggplot(aes(Jahrzehnt, n, fill = bet)) + 
  geom_bar(position="dodge", stat="identity") 
  #scale_fill_brewer(palette="Spectral")

#Histogram unserer Abstimmungen  
ggplot(ausländer, aes(Jahr)) + 
  geom_histogram(binwidth = 5)




df %>% 
  mutate(Jahrzehnt = as.factor(floor(Jahr/10)*10)) %>%
  group_by(Jahrzehnt, d1e1) %>% 
  count() %>% 
  ggplot(aes(Jahrzehnt, n, fill = d1e1)) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_brewer(palette="Spectral")


#Anzahl Abstimmungen, gruppiert nach Jahrzehnt & Thema, stacked
df_vis %>% 
  group_by(Jahrzehnt, relevant, Thema) %>% 
  count() %>% 
  ggplot(aes(Jahrzehnt, n, fill = Thema)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_brewer(palette="Spectral") +
  labs(title = "Anzahl Abstimmungen pro Jahrzehnt", subtitle =  "Gruppiert nach Themen unseres Beitrages & Rest", y = "Anzahl")

ggplot(ausländer, aes(Jahr, volk, color = Thema, size = volkja.proz))+
    geom_jitter() +
    scale_color_brewer(palette="Spectral") 

```


```{r Tabellen Anzahl Abstimmungen pro Jahrzehnt (nur Ausländer)} 
#Anzahl Abstimmungen pro Jahrzehnt in Zahlen (nur relevante Themen)
df %>% 
  filter(Jahr > 1910, relevant == "ja") %>% 
  group_by(Jahrzehnt, Thema) %>% 
  count()

#Anzahl Abstimmungen pro Rechtsform + Position Bundesrat in Zahlen (nur relevante Themen)
df_vis %>% 
  filter(Jahr > 1910, relevant == "ja") %>% 
  group_by(rechtsform, Thema, br.pos) %>% 
  count()




  
```



```{r alte Visualisierungen} 

#eingeschränkter Datensatz für Visualisierung
df_vis <- df %>% 
  select(anr, Jahr, Kurztitel, rechtsform, br.pos, Sicherheitspolitik:relevant) 

#Anzahl Abstimmungen, gruppiert nach Jahrzehnt & Thema, nebeneinander
# df_vis %>% 
#   group_by(Jahrzehnt, Thema) %>% 
#   count() %>% 
#   ggplot(aes(Jahrzehnt, n, fill = Thema)) +
#   geom_bar(position="dodge", stat="identity") +
#   scale_fill_brewer(palette="Spectral")



positionen_br <- ggplot(df, aes( Jahr,rechtsform, color = br.pos )) + geom_jitter() + scale_color_brewer(palette="Spectral") 

positionen_br

# 
# 
# df_vis %>% 
#   filter(Thema == "Ausländer"|Thema == "Flüchtlinge") %>% 
#   group_by(Jahrzehnt, relevant, Thema) %>% 
#   count() %>% 
#   ggplot(aes(Jahrzehnt, n, fill = Thema)) +
#   geom_bar(position="dodge", stat="identity") +
#   scale_fill_brewer(palette="Spectral") +
#   labs(title = "Anzahl Abstimmungen pro Jahrzehnt", subtitle =  "Gruppiert nach Themen unseres Beitrages & Rest", y = "Anzahl")
# 
# 
# df %>% 
#   filter(Thema == "Ausländer"|Thema == "Flüchtlinge") %>% 
#   group_by(Jahrzehnt, Thema, annahme) %>% 
#   count() %>% 
#   ggplot(aes(Jahrzehnt, n, fill = annahme)) +
#   geom_bar(position="stack", stat="identity") +
#   #scale_fill_brewer(palette="Spectral") +
#   labs(title = "Anzahl Abstimmungen zu Flüchtlinge / Ausländer", subtitle =  "Angenommene & abgelehnte", y = "Anzahl")




# #Abstimmungen, gruppiert nach Rechtsform & Jahrzehnt
# df %>% 
#   filter(relevant == "ja") %>% 
#   group_by(Jahrzehnt, rechtsform, Thema,annahme) %>% 
#   count() %>% 
#   ggplot(aes(Jahrzehnt, rechtsform, color = annahme)) +
#   geom_jitter() +
#   #scale_color_brewer(palette="Spectral") +
#   facet_wrap(~Thema)


# ggplot(df, aes(Jahr, volk, color = Thema, size = volkja.proz)) +
#     geom_jitter() +
#     scale_color_brewer(palette="Spectral") 
# 
# 
# ausländer %>% 
#   filter(relevant == 1) %>% 
#   ggplot(aes(Jahr, volk, color = Thema, size = volkja.proz)) +
#     geom_jitter() +
#     scale_color_brewer(palette="Spectral") 
# 

df_vis %>% 
  group_by(Jahrzehnt, Jahr, relevant, Thema) %>% 
  count() %>% 
  ggplot(aes(Jahr, n, color = Thema)) +
  geom_point() +
  facet_wrap(~Jahrzehnt)



ggplot(df, aes(Jahr, br.pos, color = Thema, shape = rechtsform)) +
  geom_jitter(alpha = 0.7) +
  scale_color_brewer(palette="Spectral") 
  #scale_y_discrete(breaks = seq(1820, 2022, 10))

  df %>% 
  filter(relevant == "ja") %>% 
  ggplot(aes(br.pos, Thema, color = rechtsform), na.rm = TRUE) +
  geom_jitter(alpha = 0.7)   +
  scale_color_brewer(palette="Spectral") 
  #scale_y_discrete(breaks = seq(1820, 2022, 10))
  
  
  df %>% 
  filter(relevant == "ja") %>% 
  ggplot(aes(Thema, rechtsform, color = br.pos)) +
  geom_jitter() 
  #scale_color_brewer(palette="Spectral") 
  #scale_y_discrete(breaks = seq(1820, 2022, 10))
  
  
  df %>% 
  filter(relevant == "ja") %>% 
  ggplot(aes(Jahr, br.pos, shape = Thema, color = rechtsform)) +
  geom_jitter(alpha = 0.7) +
  scale_color_brewer(palette="Spectral") 
  #scale_y_discrete(breaks = seq(1820, 2022, 10))



df_vis %>% 
  group_by(Jahr, relevant, Thema) %>% 
  count() %>% 
  ggplot(aes(Jahr, n, fill = Thema)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_brewer(palette="Spectral")

ggplot(df, aes(Jahr)) + 
  geom_histogram()


df %>% 
  mutate(Jahrzehnt = as.factor(floor(Jahr/10)*10)) %>%
  group_by(Jahrzehnt, d1e1) %>% 
  count() %>% 
  ggplot(aes(Jahrzehnt, n, fill = d1e1)) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_brewer(palette="Spectral")



df %>% 
  mutate(Jahrzehnt = as.factor(floor(Jahr/10)*10)) %>%
  filter(d1e1 %in% c("Aussenpolitik", "Sicherheitspolitik", "Sozialpolitik")) %>% 
  group_by(Jahrzehnt, d1e1, d2e1) %>% 
  count() %>% 
  ggplot(aes(Jahrzehnt, n, fill = d1e1)) + 
  geom_col(position="dodge", stat="identity") +
  scale_fill_brewer(palette="Spectral")


```


```{r Pro-Verschärfung / Contra Verschärfung}


kantone_japroz_mean <- data.frame(colMeans(kantone_japroz)) #Mittelwert korrigierter Ja-Prozentsatz pro Kanton
kantone_japroz_mean <- kantone_japroz_mean %>% 
  rename(pro_verschärfung = colMeans.kantone_japroz.) %>% 
  mutate(contra_verschärfung = 100- pro_verschärfung) 
  
rownames(kantone_japroz_mean) <- gsub(".japroz", "", rownames(kantone_japroz_mean), fixed=TRUE)
kantone_japroz_mean["Kantone"] <- rownames(kantone_japroz_mean)


kantone_japroz_pivoted <- kantone_japroz_mean %>% 
  pivot_longer(
    cols = pro_verschärfung:contra_verschärfung, 
    names_to = "Position", 
    values_to = "Prozent"
)

verschärfung <- ggplot(kantone_japroz_pivoted, aes(x=reorder(Kantone, Prozent), y=Prozent, fill=Position))+
  geom_bar(position="stack", stat = "identity")+
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Zustimmung zu verschärfenden Massnahmen pro Kanton",
       x = "Kanton")

ggplotly(verschärfung)
```


```{r Visualisierung Einwanderung}

as_nation[1,1] <- "Country"
as_nation[1,38] <- "2022"
as.character(as_nation[1, ])
names(as_nation) <- as_nation[1,]
as_nation <- as_nation[-1,]
total <- as_nation[186,]
as_nation <- as_nation[-186,]


cum_nat <- as_nation %>% 
  pivot_longer(
    cols = "1986":"2022",
    names_to = "Jahr", 
    values_to = "Anzahl"
  )

cum_nat <- transform(cum_nat, Anzahl = as.numeric(Anzahl))

top_land <- aggregate(cum_nat$Anzahl, by=list(Land=cum_nat$Country), FUN=sum)
top_land <- top_land %>% 
  arrange(desc(x)) %>% 
  ungroup()

laender <- as_nation[,1]

top_20 <- top_land %>% 
  mutate(Land=ifelse(Land %in% head(Land, 20), 
                     Land, "Andere"))
top_20 <- aggregate(top_20$x, by=list(Herkunftsland=top_20$Land), FUN=sum)
```


```{r eval=FALSE, include=FALSE}

as_nation[2:38] <- sapply(as_nation[2:38],as.numeric)
sapply(as_nation, class)

cum_nat <- transform(cum_nat, Anzahl = as.numeric(Anzahl))



top_land <- aggregate(cum_nat$Anzahl, by=list(Land=cum_nat$Country), FUN=sum)
top_land <- top_land %>% 
  arrange(desc(x)) %>% 
  ungroup()

laender <- as_nation[,1]

top_20 <- top_land %>% 
  mutate(Land=ifelse(Land %in% head(Land, 20), 
                     Land, "Andere"))
top_20 <- aggregate(top_20$x, by=list(Herkunftsland=top_20$Land), FUN=sum)
#ggplot(cum_nat, aes(x=Jahr, y=Anzahl, fill=Country))+
 # geom_area()
```
